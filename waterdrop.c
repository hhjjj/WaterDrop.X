/* 
 * File:   waterdrop.c
 * Author: OSSI
 *
 * Created on 2013년 6월 11일 (화), 오후 11:49
 */

#include <xc.h>
// Normal
//const char SineTable[640] = {128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 126, 126, 118, 118, 136, 136, 142, 142, 108, 108, 154, 154, 91, 91, 155, 155, 100, 100, 154, 154, 99, 99, 163, 163, 92, 92, 163, 163, 99, 99, 145, 145, 120, 120, 126, 126, 134, 134, 122, 122, 128, 128, 129, 129, 126, 126, 124, 124, 135, 135, 123, 123, 128, 128, 130, 130, 126, 126, 126, 126, 130, 130, 126, 126, 126, 126, 129, 129, 127, 127, 128, 128, 126, 126, 128, 128, 129, 129, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 129, 129, 127, 127, 127, 127, 129, 129, 127, 127, 126, 126, 128, 128, 129, 129, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 129, 129, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 126, 126, 129, 129, 126, 126, 128, 128, 129, 129, 127, 127, 128, 128, 128, 128, 127, 127, 127, 127, 127, 127, 128, 128, 126, 126, 130, 130, 125, 125, 129, 129, 126, 126, 128, 128, 127, 127, 129, 129, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 128, 128, 126, 126, 129, 129, 126, 126, 130, 130, 126, 126, 129, 129, 126, 126, 129, 129, 126, 126, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 126, 126, 129, 129, 126, 126, 129, 129, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 128, 128, 128, 128, 128, 128, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 126, 126, 129, 129, 126, 126, 129, 129, 126, 126, 129, 129, 126, 126, 128, 128, 127, 127, 129, 129, 126, 126, 129, 129, 127, 127, 129, 129, 127, 127, 128, 128, 127, 127, 127, 127, 128, 128, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 126, 126, 128, 128, 127, 127, 128, 128, 127, 128, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 128, 128, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 128, 128, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 128, 128, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 128, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 128, 127, 127, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 128, 128, 127, 127, 128, 128, 127, 127, 128, 128, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127
//};

// Loud
const char SineTable[640] = {128, 128, 129, 129, 131, 131, 129, 129, 128, 128, 113, 113, 54, 54, 198, 198, 247, 247, 0, 0, 255, 255, 0, 0, 255, 255, 0, 0, 255, 255, 0, 0, 255, 255, 0, 0, 255, 255, 0, 0, 255, 255, 67, 67, 112, 112, 182, 182, 84, 84, 135, 135, 139, 139, 117, 117, 103, 103, 187, 187, 91, 91, 131, 131, 151, 151, 116, 116, 112, 112, 146, 146, 118, 118, 115, 115, 140, 140, 127, 127, 128, 128, 118, 118, 129, 129, 138, 138, 116, 116, 140, 140, 116, 116, 132, 132, 121, 121, 130, 130, 128, 128, 125, 125, 138, 138, 126, 126, 120, 119, 140, 140, 122, 122, 118, 118, 131, 131, 136, 136, 119, 119, 140, 140, 119, 119, 131, 131, 120, 120, 128, 128, 125, 125, 130, 130, 134, 134, 125, 125, 134, 134, 120, 120, 130, 130, 127, 127, 123, 123, 137, 137, 114, 114, 142, 142, 116, 116, 135, 135, 120, 120, 133, 133, 121, 121, 135, 135, 115, 115, 139, 139, 116, 116, 134, 134, 136, 136, 124, 124, 131, 131, 128, 128, 124, 124, 125, 125, 127, 127, 133, 133, 116, 116, 146, 146, 108, 108, 141, 141, 116, 116, 129, 129, 125, 125, 136, 136, 122, 122, 135, 135, 128, 128, 126, 126, 130, 130, 135, 135, 112, 112, 138, 138, 113, 113, 144, 144, 112, 112, 137, 137, 117, 117, 138, 138, 119, 119, 127, 127, 128, 128, 122, 122, 135, 135, 127, 127, 135, 135, 116, 116, 142, 142, 115, 115, 135, 135, 127, 127, 122, 122, 133, 133, 121, 121, 133, 133, 120, 120, 135, 135, 119, 119, 139, 139, 115, 115, 138, 138, 122, 122, 132, 132, 132, 132, 121, 121, 135, 135, 123, 123, 127, 127, 126, 125, 128, 128, 128, 128, 133, 133, 119, 119, 137, 137, 115, 115, 135, 135, 121, 121, 129, 129, 129, 129, 126, 126, 134, 134, 124, 124, 130, 130, 130, 130, 123, 123, 133, 133, 118, 118, 137, 137, 117, 117, 138, 138, 117, 117, 137, 137, 118, 118, 133, 133, 120, 120, 137, 137, 119, 119, 136, 136, 123, 123, 137, 137, 124, 124, 130, 130, 126, 126, 125, 125, 131, 131, 125, 125, 123, 123, 134, 134, 121, 121, 131, 131, 122, 122, 126, 126, 126, 126, 131, 131, 127, 127, 132, 132, 129, 129, 124, 124, 134, 134, 119, 119, 135, 135, 124, 124, 130, 130, 127, 127, 128, 128, 124, 124, 130, 130, 122, 122, 130, 130, 124, 124, 128, 128, 125, 125, 131, 131, 126, 126, 129, 129, 132, 132, 125, 125, 133, 133, 122, 122, 136, 135, 121, 121, 134, 134, 123, 123, 127, 127, 125, 125, 127, 127, 126, 125, 130, 130, 129, 129, 129, 129, 127, 127, 127, 127, 125, 125, 127, 127, 127, 127, 130, 130, 129, 129, 130, 130, 127, 127, 125, 125, 126, 126, 123, 123, 128, 128, 124, 124, 132, 132, 124, 124, 133, 133, 123, 123, 133, 133, 124, 124, 133, 133, 123, 123, 132, 132, 126, 126, 127, 127, 132, 132, 124, 124, 132, 132, 125, 125, 126, 126, 125, 125, 127, 127, 126, 126, 129, 129, 128, 128, 126, 126, 127, 127, 128, 128, 126, 126, 128, 128, 129, 129, 129, 129, 130, 130, 128, 128, 130, 130, 124, 124, 129, 129, 125, 125, 125, 125, 127, 127, 124, 124, 128, 128, 127, 127, 129, 129, 127, 127, 130, 130, 125, 125, 130, 130, 125, 125, 132, 132, 126, 126, 131, 131, 127, 127, 129, 129, 125, 125, 128, 128, 127, 127, 126, 126, 129, 129, 124, 124, 129, 129, 126, 126, 128, 128, 126, 126, 129, 129, 127, 127, 128, 128, 127, 127, 130, 130, 127, 127, 128, 128, 130, 130, 126, 126, 129, 129, 125, 125, 128, 128, 126, 126, 126, 126, 127, 127, 127, 127, 126, 126
};







#pragma config CPD = OFF, BOREN = OFF, IESO = OFF, FOSC = INTOSC, FCMEN = OFF, MCLRE = ON, WDTE = OFF, CP = OFF, PWRTE = OFF, CLKOUTEN = OFF, LVP = OFF

// when CLKOUTEN = ON,  Fosc / 4 frequency can be measured via RA4 pin

// just for __delay_ms() as reference
// this is NOT for setting up clock speed
#ifndef _XTAL_FREQ
#define _XTAL_FREQ 32000000
#endif

// NOTE: PR2 value is closely related to maximum PWM resolution!!
void SetPWMDutyCyle(unsigned int duty_cycle_value)
{
    CCP1CONbits.DC1B = duty_cycle_value & 0x03; //first set the 2 lsb bits
    CCPR1L =  (duty_cycle_value >> 2);           //now set upper 8 msb bits
}


unsigned int  step;
void main(void) {

    // set high speed internal osc to 8 MHz and 4xPLL on => 32MHz clock speed
    OSCCON = 0b11110000;
    //OSCTUNE= 0x1F;			//33 MHz clok really , tune this if you want to have accurate frequency

    // Set up I/O pins
    ANSELAbits.ANSELA=0;    // set all analog pins to digital I/O
    ADCON0bits.ADON=0;      // turn ADC off
    DACCON0bits.DACEN=0;    // turn DAC off

    INTCON = 0b11000000;	// global ints enabled peripheral interrupts enabled , all sources masked
    OPTION_REG = 0b10000011;	//no weak pull-ups, timer0 at OSC/4/2 = osc/ 8

    // PORT A Assignments
    TRISAbits.TRISA0 = 0;	// RA0 = nc
    TRISAbits.TRISA1 = 0;	// RA1 = nc
    TRISAbits.TRISA2 = 0;	// RA2 = PWM Output (CCP1) connected to LED
    TRISAbits.TRISA3 = 0;	// RA3 = nc (MCLR)
    TRISAbits.TRISA4 = 0;	// RA4 = nc
    TRISAbits.TRISA5 = 0;	// RA5 = nc

    APFCONbits.CCP1SEL=0;       // The CCP1SEL bit selects which pin the PWM output is on.
                                // The default value for this bit is 0 which sets the
                                // PWM output on RA2.  If you want the PWM output on
                                // RA5 instead then set this bit to a 1.


     //******************************************************************************************
    // PWM Period = (1/Fosc) * 4 * (TMR2 Prescaler)* (PR2+1)
    //******************************************************************************************
    // Here are sample PWM periods for different TMR2 Prescalar values for Fosc=32Mhz and PR2=255
    //******************************************************************************************
    // TMR2 Prescalar=1: PWM Period = (1/32000000)*4*1*256 = 32 us or 31.25 khz
    // TMR2 Prescalar=4: PWM Period = (1/32000000)*4*4*256 = 128 us or 7.81 khz
    // TMR2 Prescalar=16: PWM Period = (1/32000000)*4*16*256= 512 ms or 1.953 khz
    // TMR2 Prescalar=64: PWM Period = (1/32000000)*4*64*256= 2.048 ms or .488 khz
    //
    // For this example we will choose the PWM period of 32us (31.25 kHz) so most people
    // will not be able to hear it.

    // ***** Setup PWM output ******************************************************

    TRISAbits.TRISA2 = 1;       // disable pwm pin output for the moment

    CCP1CONbits.CCP1M=0x0C;     // select PWM mode for CCP module
    CCP1CONbits.P1M=0x00;	// select single output on CCP1 pin (RA5)

    PR2 = 124;                 // set PWM period as 255 per our example above ( 4 kHz )
    // NOTE: PWM resolution is a function of PR2
    //PR2 = 0x3F;                 // set PWM period as 0x3F (125kHz), then PWM resoution is 8 bit

    CCPR1L =  0x00;             // clear high 8 bits of PWM duty cycle
    CCP1CONbits.DC1B=0x00;	// clear low 2 bits of PWM Duty cycle

                                // Note: PWM uses TMR2 so we need to configure it
    PIR1bits.TMR2IF=0;		// clear TMR2 interrupt flag
    //T2CONbits.T2CKPS=0b00;      // select TMR2 prescalar as divide by 1 as per our example above
    T2CONbits.T2CKPS=0b10;      // select TMR2 prescalar as divide by 1 as per our example above
    T2CONbits.TMR2ON=1;		// turn TMR2 on
    
    PIE1bits.TMR2IE = 1; //turn TMR2 int on

    TRISAbits.TRISA2 = 0;	// turn PWM output back on


//    TMR0 = 0;
//    INTCONbits.TMR0IF = 0;
//    INTCONbits.TMR0IE = 1;
    
    step = 0;
    RA4 = 0;
    SetPWMDutyCyle(255); // 50% duty ratio
    //volatile unsigned int i  = 0 ;
    while(1)
    {

    }
}

void interrupt isr(void)
{
    if ( TMR2IF == 1)
    {
        // half the frequency of PWM = 2 kHz
        RA4 = ~RA4;
        PIR1bits.TMR2IF = 0;
    }
//    TMR0 = 30; // sound sampling rate around 2.2kHz
//    RA4 = ~RA4; // 1.1 kHz toggling
//    SetPWMDutyCyle(SineTable[step]);
//
//    step++;
//
//    if (step > 640)
//    {
//        SetPWMDutyCyle(0);
//        //INTCONbits.TMR0IE = 0;
//        step = 0;
//    }
//
//    INTCONbits.TMR0IF = 0;

}
